<!DOCTYPE html><html lang="es"><head><title>Alfonso Miranda - Mobile Software Engineer</title><meta name="twitter:title" content="Alfonso Miranda - Mobile Software Engineer"/><meta name="og:title" content="Alfonso Miranda - Mobile Software Engineer"/><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css"/><link rel="stylesheet" href="/Pure/styles.css"/><link rel="stylesheet" href="/all.css"/></head><body><div id="layout" class="pure-g"><div><div class="pure-menu pure-menu-horizontal pure-u-1-1 top-header"><ul class="pure-menu-list"><li class="pure-menu-item"><a class="pure-menu-link" href="/about">Sobre mi</a></li></ul></div></div><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><div id="layout" class="pure-g"><div class="pure-u-md-1-1 pure-u-3-4"><h1><a class="brand-title" href="/">Alfonso Miranda</a></h1><h3 class="brand-tagline">Mobile Software Engineer</h3></div></div><div id="layout" class="pure-g"><div class="pure-u-md-1-1"><a href="https://www.linkedin.com/in/alfonsomirandacastro/"><i class="fab fa-linkedin l-box social-icon"></i><a class="social-media" href="https://www.linkedin.com/in/alfonsomirandacastro/">LinkedIn</a></a></div><div class="pure-u-md-1-1"><a href="https://github.com/alfonsomiranda"><i class="fab fa-github-square l-box social-icon"></i><a class="social-media" href="https://github.com/alfonsomiranda">GitHub</a></a></div><div class="pure-u-md-1-1"><a href="https://twitter.com/alfonsobeta"><i class="fab fa-twitter-square l-box social-icon"></i><a class="social-media" href="https://twitter.com/alfonsobeta">Twitter</a></a></div><div class="pure-u-md-1-1"><a href="https://twitch.alfonsomiranda.com"><i class="fab fa-twitch l-box social-icon"></i><a class="social-media" href="https://twitch.alfonsomiranda.com">Twitch</a></a></div></div></div></div><div class="content pure-u-1 pure-u-md-3-5 pure-u-xl-6-10"><h2 class="post-title"><a href="/posts/create-api-vapor">Crear una API con Vapor en swift</a></h2><p class="post-meta">20 de mayo de 2021</p><div class="post-tags"><a class="post-category post-category-swift" href="/tags/swift">swift</a><a class="post-category post-category-vapor" href="/tags/vapor">vapor</a><a class="post-category post-category-heroku" href="/tags/heroku">heroku</a><a class="post-category post-category-api" href="/tags/api">api</a><a class="post-category post-category-rest" href="/tags/rest">rest</a></div><div class="post-description"><div><p>A los que desarrollamos en swift nos suele gustar mucho este lenguaje de programación, y nos gustaría hacerlo todo con él. Por suerte, es posible hacer todo (o casi todo), y hoy vamos a ver como montar nuestro backend en swift y no necesitar a nada ni nadie más. Existen varios frameworks que nos ayudan en este trabajo pero, en mi opinión, el más completo es Vapor. Vapor no es más que un framework web escrito en swift para montar web o servicios web, emulando a otros como nodejs y siguiendo una filosofía similar. Vamos a ver una pequeña introducción de como usarlo e incluso como desplegarlo en un servidor en la nube.</p><h1>Instalando Vapor</h1><p>Para instalar Vapor tenemos que ejecutar estos comandos usando <a href="https://brew.sh/index_es">brew</a>, el cual deberíamos tener previamente instalado.</p><pre><code>brew tap vapor/tap
brew install vapor/tap/vapor
</code></pre><p>A partir de aquí, con el siguiente comando creariamos un nuevo proyecto Vapor.</p><pre><code>vapor new <span class="type">VaporTest</span>
</code></pre><p>siendo VaporTest el nombre que le queramos dar al proyecto, donde nos irá preguntando una serie de cosas, como si queremos usar diferentes frameworks (Fluent, Leaf) o que base de datos usar, si queremos. En nuestro caso vamos a usar Fluent, un framework que nos ayuda con SQL y bases de datos postgresSQL. Todo es opcional y podemos no querer usar nada y ejecutar esta alternativa para que directamente ni nos pregunte.</p><pre><code>vapor new <span class="type">VaporTest</span> -n
</code></pre><p>Abrimos el proyecto ejecutando dentro de la carpeta generada lo siguiente y ejecutamos</p><pre><code>vapor xcode
</code></pre><p>o</p><pre><code><span class="keyword">open</span> <span class="type">Package</span>.<span class="property">swift</span>
</code></pre><p>y se abrirá nuestro proyecto en XCode. Una vez descargadas todas las dependencias (puede tardar un poquito), hacemos run y se nos montará un servidor en la dirección http://127.0.0.1:8080</p><img src="/images/vapor/itsworks.png" alt="It's works in Vapor" width="800"/><p>Aquí podemos tener un problema a la hora de volverlo a ejecutar, ya que se habrá quedado el proceso en background y no nos dejará volverlo a lanzar hasta que matemos ese proceso. Para matarlo primero buscamos cual es su id de esta forma:</p><pre><code>netstat -vanp tcp | grep <span class="number">8080</span>
</code></pre><p>y después, con el id del proceso, lo matamos.</p><pre><code>kill -<span class="number">9</span> idProceso
</code></pre><p>Para no tener que hacer esto todo el tiempo podemos hacer dos cosas:</p><ul><li>Configurar el proyecto para que sepa donde tenemos la ejecución del proyecto como vemos en la imagen.</li></ul><img src="/images/vapor/itsworks.png" alt="It's works in Vapor" width="800"/><p>O ejecutarlo desde consola con el comando.</p><pre><code>vapor run
</code></pre><p>y cuando queramos pararlo y matarlo simplemente pulsar <code>ctrl + C</code></p><h1>Proyecto de ejemplo</h1><h1>Configuramos la base de datos</h1><p>En nuestro caso vamos a usar postgreSQL, así que en primer lugar vamos a instalarlo. Lo haremos con brew</p><pre><code>brew install postgresql
</code></pre><p>y la arrancamos</p><pre><code>brew services start postgresql
</code></pre><p>Añadimos la configuración en nuestro proyecto. Hay varias formas, en el código de ejemplo vemos una donde tan solo tendríamos que añadir las credenciales de nuestro postgres, pero vamos a hacerlo de una forma más elegante y que nos servirá en el futuro para tener varios entornos. Creamos un fichero <code>.env.development</code> con lo siguiente:</p><pre><code><span class="type">DB_URL</span>=postgres://myuser:mypass@localhost:<span class="number">5432</span>/mydb
</code></pre><p>y en <code>configure.swift</code> cambiamos la configuración por esto</p><pre><code><span class="keyword">extension</span> <span class="type">Application</span> {
    <span class="keyword">static let</span> databaseUrl = <span class="type">URL</span>(string: <span class="type">Environment</span>.<span class="call">get</span>(<span class="string">"DB_URL"</span>)!)!
}

<span class="keyword">public func</span> configure(<span class="keyword">_</span> app: <span class="type">Application</span>) <span class="keyword">throws</span> {
    
    <span class="keyword">try</span> app.<span class="property">databases</span>.<span class="call">use</span>(.<span class="call">postgres</span>(url: <span class="type">Application</span>.<span class="property">databaseUrl</span>), as: .<span class="dotAccess">psql</span>)
    
    <span class="comment">//...</span>
}
</code></pre><p>Con esto ya deberíamos tener conexión y tendremos que hacer la migración de nuestras clases a tablas, ejecutando lo siguiente:</p><pre><code>vapor run migrate
</code></pre><h1>Empezamos a montar nuestra API</h1><p>En primer lugar vamos a crearnos el modelo el cual usaremos para nuestra API. En nuestro ejemplo, será un objeto "Mensaje" que contendrá un titulo, un contenido y una fecha.</p><h1>Desplegar en Heroku</h1><pre><code>brew tap heroku/brew &amp;&amp; brew install heroku
</code></pre><pre><code>heroku create vapor-tutorial --region eu
</code></pre><pre><code>heroku git:remote -a vapor-tutorial
</code></pre><p>Creamos un archivo Procfile con el siguiente contenido</p><pre><code>web: <span class="type">Run</span> serve --env production --hostname <span class="number">0.0.0.0</span> --port $PORT
</code></pre><p>Y lo añadimos al repositorio.</p><pre><code>git add <span class="type">Procfile</span>
git commit -m <span class="string">"Added Procfile"</span>
</code></pre><p>Añadimos un buildpack para que heroku entienda a Vapor</p><pre><code>heroku buildpacks:<span class="keyword">set</span> vapor/vapor
</code></pre><p>Y por último creamos un fichero para indicar qué versión de swift estamos usando.</p><pre><code>echo <span class="string">"5.3.3"</span> &gt; .<span class="dotAccess">swift</span>-version
</code></pre><p>Cambiando por la versión que estamos usando.</p><p>Y hacemos commit y push a heroku para subir y desplegar.</p><pre><code>git commit -m <span class="string">"Upload to heroku"</span>
git push heroku master 
</code></pre></div></div></div><div class="footer pure-u-1"><div class="pure-u-1">© 2021 Alfonso Miranda</div><div class="pure-u-1">Generated using <a href="https://github.com/johnsundell/publish">Publish</a>. Written in Swift</div><div class="pure-u-1"><a href="/feed.rss">RSS feed</a></div></div></div></body></html>